<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plinkoball (Free Demo)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --card: #111834;
      --muted: #9fb0ff;
      --accent: #6ca6ff;
      --accent-2: #7bffca;
      --text: #eaf0ff;
      --danger: #ff6b6b;
      --ok: #22c55e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, #1b2450, var(--bg));
      overflow: hidden;
    }
    .wrap {
      display: grid;
      grid-template-columns: 360px 1fr 320px;
      gap: 16px;
      padding: 16px;
      height: 100%;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding: 14px 14px 12px;
    }
    h1 {
      font-size: 18px; margin: 0 0 10px; letter-spacing: 0.3px; color: var(--muted);
    }
    label { font-size: 13px; color: #cbd5ff; display:block; margin: 10px 0 4px; }
    input[type="number"], select, input[type="text"] {
      width: 100%;
      background: #0d1533;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
    }
    input[type="range"] { width: 100%; }
    .row { display:flex; gap:8px; align-items:center; }
    .btn {
      background: linear-gradient(180deg, var(--accent), #3d7fff);
      color: #041225;
      border: none; border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor:pointer;
      box-shadow: 0 8px 18px rgba(108,166,255,0.35);
    }
    .btn.secondary { background: #182558; color: var(--text); box-shadow:none; border:1px solid rgba(255,255,255,0.08); }
    .btn.ghost { background: transparent; color: var(--muted); border:1px solid rgba(255,255,255,0.15); }
    .stack { display:flex; flex-direction:column; gap:10px; }
    .muted { color: #b7c4ff; opacity: 0.8; font-size: 12px; }
    .big { font-size: 22px; font-weight:800; letter-spacing:0.2px; }
    .balance { display:flex; align-items:baseline; justify-content:space-between; background:#0e1637; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.07); }
    .canvas-wrap { position: relative; }
    #world { width: 100%; height: 100%; background: radial-gradient(600px 400px at 50% 0%, #162358, #0a0f1f); border-radius: 16px; border:1px solid rgba(255,255,255,0.08); }
    .payout-row { display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; }
    .payout-row .chip { text-align:center; background:#0d1533; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,0.10); font-weight:600; }
    .chip.win { background: rgba(34,197,94,0.12); border-color: rgba(34,197,94,0.35); }
    .chip.lose { background: rgba(255,107,107,0.10); border-color: rgba(255,107,107,0.35); }
    .history { height: calc(100% - 38px); overflow:auto; padding-right: 6px; }
    .hist { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.07); background:#0e1637; margin-bottom:8px; font-size:13px; }
    .hist .x { font-weight:800; }
    .pill { padding:2px 8px; border-radius:999px; font-weight:700; }
    .green { color: #22c55e; background: rgba(34,197,94,0.12); border:1px solid rgba(34,197,94,0.35); }
    .red { color: var(--danger); background: rgba(255,107,107,0.10); border:1px solid rgba(255,107,107,0.35); }
    .flex { display:flex; gap:8px; align-items:center; }
    .stretch { display:grid; grid-template-rows:auto 1fr; gap: 10px; height: 100%; }
    .footer { font-size:11px; opacity:0.7; }
    .grid {
      display:grid; gap:16px; grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; overflow:auto; } body { overflow:auto; } }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card stack" id="left">
      <h1>Controls</h1>
      <div class="balance"><div>Balance</div><div class="big" id="balance">10,000.00</div></div>
      <label>Bet amount</label>
      <div class="row">
        <input type="number" id="bet" min="0.01" step="0.01" value="1.00" />
        <button class="btn secondary" id="max">MAX</button>
      </div>

      <label>Rows <span class="muted" id="rowsLabel">12</span></label>
      <input type="range" id="rows" min="8" max="16" value="12" />

      <label>Risk profile</label>
      <select id="risk">
        <option value="low">Low</option>
        <option value="medium" selected>Medium</option>
        <option value="high">High</option>
      </select>

      <label>Balls per click</label>
      <select id="count">
        <option>1</option>
        <option>5</option>
        <option selected>10</option>
        <option>25</option>
        <option>50</option>
      </select>

      <div class="row">
        <button class="btn" id="drop">DROP</button>
        <button class="btn ghost" id="auto">Auto (off)</button>
        <button class="btn secondary" id="reset">Reset</button>
      </div>

      <div class="grid">
        <div>
          <label>Client seed (visual only)</label>
          <input type="text" id="seed" value="my-seed-0001" />
        </div>
        <div>
          <label>RNG</label>
          <select id="rng">
            <option value="js" selected>Browser (Math.random)</option>
            <option value="mulberry">Mulberry32</option>
          </select>
        </div>
      </div>

      <div>
        <label>Current payout table</label>
        <div id="payouts" class="payout-row"></div>
      </div>

      <div class="footer">100% play‑money. No deposits, no withdrawals, no accounts. Pure visuals for fun/testing so it looks and feels like the real thing.</div>
    </section>

    <section class="card stretch">
      <h1>Plinkoball</h1>
      <div class="canvas-wrap">
        <canvas id="world"></canvas>
      </div>
    </section>

    <section class="card stretch">
      <h1>History</h1>
      <div class="history" id="history"></div>
    </section>
  </div>

  <!-- Matter.js for simple physics -->
  <script src="https://unpkg.com/matter-js@0.20.0/build/matter.min.js"></script>
  <script>
    // ---------- Utilities ----------
    const fmt = n => Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

    function mulberry32(a) {
      return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function strHash(s){ let h=1779033703^s.length; for(let i=0;i<s.length;i++){h=Math.imul(h^s.charCodeAt(i),3432918353); h=h<<13|h>>>19;} return (h>>>0); }

    function buildPayouts(rows, risk){
      // crude but convincing multipliers per slot using a shaped triangle distribution
      const slots = rows + 1;
      const center = (slots - 1)/2;
      const base = [];
      for (let i=0; i<slots; i++){
        const d = Math.abs(i - center) / center; // 0 center, 1 edge
        let m;
        if (risk==='low')      m = 0.4 + (1.2 - 0.4)*(1 - Math.pow(d, 1.8));
        else if (risk==='high') m = 0.1 + (15.0 - 0.1)*Math.pow(d, 2.2); // spicy edges
        else                    m = 0.2 + (5.5  - 0.2)*Math.pow(d, 1.8);
        base.push(Number(m.toFixed(2)));
      }
      // Normalize EV to ~0.96 for casino‑ish feel but keep play‑money; scale so mean ≈ 0.96x
      const avg = base.reduce((a,b)=>a+b,0)/base.length;
      const scale = 0.96/avg;
      return base.map(v=>Number((v*scale).toFixed(2)));
    }

    // ---------- DOM & State ----------
    const el = id => document.getElementById(id);
    const betEl = el('bet');
    const rowsEl = el('rows');
    const rowsLabel = el('rowsLabel');
    const riskEl = el('risk');
    const countEl = el('count');
    const dropBtn = el('drop');
    const autoBtn = el('auto');
    const resetBtn = el('reset');
    const maxBtn = el('max');
    const payoutsEl = el('payouts');
    const balanceEl = el('balance');
    const historyEl = el('history');
    const seedEl = el('seed');
    const rngEl = el('rng');

    let balance = 10000;
    let auto = false;
    let engine, render, world, ground, leftWall, rightWall;
    let pegs = [], bins = [];
    let balls = [];

    function updateBalance(){ balanceEl.textContent = fmt(balance); }

    function renderPayouts(){
      const payouts = buildPayouts(Number(rowsEl.value), riskEl.value);
      payoutsEl.innerHTML = '';
      const maxSlots = Math.max(8, payouts.length);
      payoutsEl.style.gridTemplateColumns = `repeat(${payouts.length}, 1fr)`;
      payouts.forEach((m,i)=>{
        const div = document.createElement('div');
        div.className = 'chip';
        div.textContent = m.toFixed(2) + '×';
        if (i===0 || i===payouts.length-1) div.style.borderColor='rgba(255,255,255,0.35)';
        payoutsEl.appendChild(div);
      });
      return payouts;
    }

    function addHistory({bet, payout, win, slot}){
      const row = document.createElement('div');
      row.className = 'hist';
      const left = document.createElement('div');
      left.innerHTML = `<span class="x">${payout.toFixed(2)}×</span> <span class="muted">slot ${slot+1}</span>`;
      const right = document.createElement('div');
      const profit = bet*(payout-1);
      right.innerHTML = `<span class="pill ${win? 'green':'red'}">${(win? '+':'')}${fmt(bet*payout - bet)}</span>`;
      row.appendChild(left); row.appendChild(right);
      historyEl.prepend(row);
    }

    // ---------- Physics world setup ----------
    const { Engine, Render, Runner, World, Bodies, Body, Composite, Events } = Matter;

    function fitCanvas(){
      const canvas = el('world');
      const parent = canvas.parentElement;
      canvas.width = parent.clientWidth;
      canvas.height = Math.max(480, parent.clientHeight - 8);
      if (render){ render.canvas = canvas; render.options.width = canvas.width; render.options.height = canvas.height; }
    }

    function makePeg(x, y){
      return Bodies.circle(x, y, 4.5, { isStatic: true, render: { fillStyle: '#7aa2ff' } });
    }

    function rebuildBoard(){
      if (engine) {
        World.clear(engine.world, true);
        Engine.clear(engine);
      }
      engine = Engine.create();
      world = engine.world;

      const canvas = el('world');
      const width = canvas.width;
      const height = canvas.height;

      const rows = Number(rowsEl.value);
      const cols = rows + 1;
      const spacingX = Math.min(48, (width - 80) / cols);
      const spacingY = Math.min(36, (height - 180) / (rows + 3));
      const offsetX = (width - spacingX * (cols-1)) / 2;
      const offsetY = 80;

      pegs = [];
      for (let r=0; r<rows; r++){
        for (let c=0; c<=r; c++){
          const x = offsetX + (cols - r - 1) * spacingX/2 + c * spacingX;
          const y = offsetY + r * spacingY;
          pegs.push(makePeg(x, y));
        }
      }
      World.add(world, pegs);

      // walls & floor
      ground = Bodies.rectangle(width/2, height-10, width, 40, { isStatic: true, render:{ fillStyle: '#0b1020' } });
      leftWall = Bodies.rectangle(5, height/2, 10, height, { isStatic: true, render:{ fillStyle:'#0b1020'} });
      rightWall = Bodies.rectangle(width-5, height/2, 10, height, { isStatic: true, render:{ fillStyle:'#0b1020'} });
      World.add(world, [ground, leftWall, rightWall]);

      // bin dividers
      const slots = rows + 1;
      bins = [];
      const baseY = offsetY + rows * spacingY + 20;
      for (let i=0;i<slots+1;i++){
        const x = offsetX + i * spacingX;
        const stick = Bodies.rectangle(x, baseY, 6, 180, { isStatic: true, render:{ fillStyle:'#233062' } });
        bins.push(stick);
      }
      World.add(world, bins);

      // roof (spawn limiter)
      const roof = Bodies.rectangle(width/2, 20, width, 40, { isStatic: true, render:{ visible:false } });
      World.add(world, roof);

      // renderer
      if (render) Render.stop(render);
      render = Render.create({
        canvas: el('world'),
        engine,
        options: {
          width, height, wireframes: false, background: 'transparent',
          pixelRatio: window.devicePixelRatio || 1
        }
      });
      Render.run(render);

      Runner.run(Engine.create(), engine);
    }

    function currentRng(){
      if (rngEl.value === 'js') return Math.random;
      const seed = strHash(seedEl.value);
      return mulberry32(seed>>>0);
    }

    function dropBalls(n){
      const canvas = el('world');
      const width = canvas.width;
      const rows = Number(rowsEl.value);
      const slots = rows + 1;
      const spacingX = Math.min(48, (width - 80) / slots);
      const offsetX = (width - spacingX * (slots-1)) / 2;
      const rng = currentRng();

      const payouts = buildPayouts(rows, riskEl.value);
      const bet = Math.max(0, Number(betEl.value) || 0);
      if (bet<=0) return;

      for (let i=0;i<n;i++){
        const x = offsetX + (slots-1)/2 * spacingX + (rng()-0.5)*spacingX*0.4; // near middle
        const ball = Bodies.circle(x, 40, 6.5, {
          restitution: 0.35, friction: 0.02, frictionAir: 0.001,
          render: { fillStyle: '#7bffca', strokeStyle: '#0a2330', lineWidth: 1.2 }
        });
        ball._bet = bet; ball._payouts = payouts; ball._settled = false; ball._rows = rows;
        World.add(world, ball);

        // nudge sideways so the board isn't too uniform
        Body.setVelocity(ball, {x: (rng()-0.5)*2.2, y: 0});
        balls.push(ball);
      }
    }

    function settleCheck(){
      const canvas = el('world');
      const width = canvas.width;
      const rows = Number(rowsEl.value);
      const slots = rows + 1;
      const spacingX = Math.min(48, (width - 80) / slots);
      const offsetX = (width - spacingX * (slots-1)) / 2;
      const baseY = 80 + rows * Math.min(36, (canvas.height - 180) / (rows + 3)) + 20;

      balls.forEach(ball=>{
        if (ball._settled) return;
        if (ball.position.y > baseY + 60 && Math.abs(ball.velocity.y) < 0.3){
          // compute slot by x
          const x = ball.position.x;
          let slot = Math.round((x - offsetX)/spacingX);
          slot = Math.max(0, Math.min(slots-1, slot));
          const mul = ball._payouts[slot];
          const winAmount = ball._bet * mul;
          const profit = winAmount - ball._bet;
          balance += profit; updateBalance();
          addHistory({bet: ball._bet, payout: mul, win: profit>=0.001, slot});
          ball._settled = true;
        }
      });
      // prune old balls to keep perf decent
      balls = balls.filter(b=> b.position.y < canvas.height + 100);
      requestAnimationFrame(settleCheck);
    }

    // ---------- Wire up UI ----------
    function refresh(){ rowsLabel.textContent = rowsEl.value; renderPayouts(); rebuildBoard(); }

    window.addEventListener('resize', ()=>{ fitCanvas(); rebuildBoard(); });

    dropBtn.addEventListener('click', ()=>{
      const n = Number(countEl.value);
      const total = (Number(betEl.value)||0)*n;
      if (total>0) balance -= total;
      updateBalance();
      dropBalls(n);
    });

    autoBtn.addEventListener('click', ()=>{
      auto = !auto;
      autoBtn.textContent = `Auto (${auto? 'on':'off'})`;
    });

    setInterval(()=>{ if (auto) dropBtn.click(); }, 650);

    resetBtn.addEventListener('click', ()=>{
      balance = 10000; updateBalance(); historyEl.innerHTML=''; rebuildBoard();
    });

    maxBtn.addEventListener('click', ()=>{ betEl.value = Math.max(1, balance/10).toFixed(2); });

    [rowsEl, riskEl].forEach(ctrl=> ctrl.addEventListener('input', ()=>{ renderPayouts(); rebuildBoard(); }));
    [seedEl, rngEl].forEach(ctrl=> ctrl.addEventListener('input', ()=>{ /* affects randomness only */ }));

    // ---------- Init ----------
    (function init(){
      fitCanvas();
      updateBalance();
      renderPayouts();
      rebuildBoard();
      settleCheck();
    })();
  </script>
</body>
</html>
